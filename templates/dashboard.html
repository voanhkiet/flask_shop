{% extends "base.html" %}
{% block content %}
<div class="dashboard-container">
  <h2>üë§ Welcome, {{ user.username }}!</h2>
<div id="avatarWrapper" style="position: relative; display: inline-block; cursor: pointer;">
  <img id="dashboardAvatar" 
       src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar) }}" 
       alt="Avatar"
       style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;">
  <div id="overlayText" 
       style="position: absolute; bottom: 0; width: 100%; text-align: center; background: rgba(0,0,0,0.5); color: white; font-size: 12px; border-radius: 0 0 50% 50%; display: none;">
    Change
  </div>
</div>

<!-- Hidden input -->
<form id="avatarForm" enctype="multipart/form-data" style="display:none;">
  <input type="file" id="avatarInput" name="avatar" accept="image/*">
</form>

  <a href="{{ url_for('edit_profile') }}" class="edit-link">‚úèÔ∏è Edit Profile</a>

  <p class="subtext">Here's a summary of your shopping activity.</p>

  <div class="stats">
    <div class="card">
      <h3>Total Orders</h3>
      <p>{{ total_orders }}</p>
    </div>
    <div class="card">
      <h3>Total Spent</h3>
      <p>${{ "%.2f" | format(total_spent) }}</p>
    </div>
    <div class="card">
      <h3>Delivered</h3>
      <p>{{ delivered_orders }}</p>
    </div>
  </div>

  <h3 class="orders-heading">üì¶ Recent Orders</h3>

  <table class="orders-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Status</th>
        <th>Invoice</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td><a href="{{ url_for('order_detail', order_id=order.id) }}">#{{ order.id }}</a></td>
        <td>{{ order.date.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>${{ "%.2f"|format(order.total) }}</td>
        <td>{% if order.is_paid %}‚úÖ{% else %}‚ùå{% endif %}</td>
        <td>{{ order.shipping_status or "Processing" }}</td>
        <td><a href="{{ url_for('download_invoice', order_id=order.id) }}" class="btn">PDF</a></td>
        
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if not orders %}
  <p class="no-orders">You haven‚Äôt placed any orders yet.</p>
  {% endif %}
</div>

<style>
.dashboard-container {
  max-width: 900px;
  margin: 40px auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.subtext {
  color: #555;
  margin-bottom: 30px;
}

.stats {
  display: flex;
  gap: 20px;
  margin-bottom: 40px;
}

.card {
  flex: 1;
  background: #f7f7f7;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
}

.card h3 {
  color: #555;
  margin-bottom: 10px;
}

.card p {
  font-size: 1.8em;
  font-weight: bold;
  color: #333;
}

.orders-heading {
  margin-top: 30px;
}

.orders-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.orders-table th, .orders-table td {
  padding: 12px;
  border-bottom: 1px solid #eee;
  text-align: center;
}

.orders-table th {
  background: #fafafa;
}

.orders-table a {
  text-decoration: none;
  color: #007bff;
}

.btn {
  background: #4CAF50;
  color: white;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 0.9em;
  text-decoration: none;
}

.btn:hover {
  background: #45a049;
}

.no-orders {
  text-align: center;
  margin-top: 30px;
  color: #888;
}
.edit-link {
  float: right;
  text-decoration: none;
  color: #007bff;
  font-size: 0.9em;
}
.edit-link:hover {
  text-decoration: underline;
}
.avatar-dashboard {
  border-radius: 50%;
  border: 2px solid #ddd;
  width: 100px;
  height: 100px;
  object-fit: cover;
  margin-bottom: 10px;
}
.avatar-dashboard:hover {
  transform: scale(1.05);
  transition: 0.3s ease;
  border-color: #4caf50;
}


</style>
<script>
const avatarInput = document.getElementById('avatarInput');
const dashboardAvatar = document.getElementById('dashboardAvatar');
const overlayText = document.getElementById('overlayText');
const avatarWrapper = document.getElementById('avatarWrapper');

// Hover overlay
avatarWrapper.addEventListener('mouseenter', () => overlayText.style.display = 'block');
avatarWrapper.addEventListener('mouseleave', () => overlayText.style.display = 'none');

// Click to choose new file
avatarWrapper.addEventListener('click', () => avatarInput.click());

// Preview & upload instantly
avatarInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Show preview immediately
  const reader = new FileReader();
  reader.onload = (event) => dashboardAvatar.src = event.target.result;
  reader.readAsDataURL(file);

  // Upload file via fetch (AJAX)
  const formData = new FormData();
  formData.append('avatar', file);

  fetch('/edit_profile', {
    method: 'POST',
    body: formData
  })
  .then(res => {
    if (res.ok) {
      alert('‚úÖ Avatar updated successfully!');
    } else {
      alert('‚ö†Ô∏è Upload failed, please try again.');
    }
  })
  .catch(err => {
    console.error(err);
    alert('‚ö†Ô∏è An error occurred during upload.');
  });
});
</script>

{% endblock %}
